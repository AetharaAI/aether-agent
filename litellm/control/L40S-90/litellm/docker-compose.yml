version: '3.8'

services:
  # --- The Gateway (LiteLLM) ---
  # Replaces "apriel-router". Access this at http://localhost:8001
  litellm:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: aether-gateway
    restart: always
    ports:
      - "8001:4000" # Maps LiteLLM's 4000 to your exposed 8001
    volumes:
      - ./litellm_config/config.yaml:/app/config.yaml
    command: [ "--config", "/app/config.yaml", "--detailed_debug"]
    environment:
      - DATABASE_URL=postgresql://user:password@postgres:5432/litellm # Optional: if you want auth logging
    depends_on:
      - vllm
      - vllm-mistral

  # --- Model 1: Apriel 1.6 (Vision + Thinking) ---
  vllm:
    image: vllm/vllm-openai:latest
    container_name: apriel-engine
    runtime: nvidia
    restart: unless-stopped
    environment:
      - HF_HOME=/root/.cache/huggingface
    volumes:
      - /mnt/block_storage/apriel_1.6_awq:/app/model
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['0']
              capabilities: [gpu]
    command: >
      --model /app/model
      --served-model-name "apriel-1.6-15b-thinker"
      --quantization awq
      --dtype half
      --gpu-memory-utilization 0.45
      --max-model-len 16384
      --port 8000
      --trust-remote-code

  # --- Model 2: Mistral Small 24B or DeepSeek-R1-Distill ---
  vllm-mistral:
    image: vllm/vllm-openai:latest
    container_name: mistral-engine
    runtime: nvidia
    restart: unless-stopped
    environment:
      - HF_HOME=/root/.cache/huggingface
    volumes:
      - /mnt/block_storage/mistral_24b_awq:/app/model
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['0']
              capabilities: [gpu]
    command: >
      --model /app/model
      --served-model-name "mistral-small-24b"
      --quantization awq
      --dtype half
      --gpu-memory-utilization 0.45
      --max-model-len 16384
      --port 8000

networks:
  default:
    driver: bridge
